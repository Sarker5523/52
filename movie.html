<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video Details</title>
  <meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.youtube.com https://mp.rpmhub.site https://cybervynx.com; connect-src 'self' https://api.themoviedb.org;">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Inter:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    #main-cast, #imdb-categories { display: block; }
    .search-suggestion img {
      width: 40px; height: 60px; object-fit: cover; border-radius: 6px; background: #333;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <div class="logo" onclick="window.location.href = 'index.html'" role="button" aria-label="StreamOn Home">StreamOn</div>
    <div class="nav-links">
      <a href="index.html" aria-label="Home">Home</a>
      <div class="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
        Categories
        <div class="dropdown-content" id="category-list"></div>
      </div>
      <div class="search-container">
        <input type="text" id="search-box" class="search-box" placeholder="Search..." autocomplete="off" aria-label="Search movies" />
        <div id="search" class="search" role="listbox"></div>
      </div>
    </div>
  </div>

  <div class="video-container" id="video-container">
    <div class="iframe-container" id="iframe-container" style="display: none;" role="region" aria-label="Video player"></div>
  </div>

  <div class="video-details">
    <h2 id="video-title" aria-live="polite"></h2>
    <div id="source-selection" class="episode-list"></div>
    <div class="movie-info" id="movie-info" style="display: none;">
      <div class="plot-container">
        <div class="plot-text">
          <h3>Plot</h3>
          <p id="movie-plot"></p>
        </div>
      </div>
      <div class="info-columns">
        <div class="left-column">
          <h3>Director</h3><div id="director" class="director"></div>
          <h3>Genres</h3><div id="imdb-categories" class="imdb-categories"></div>
          <h3>Main Cast</h3><div id="main-cast" class="cast-list"></div>
          <h3>Released Year</h3><div id="release-year" class="release-year"></div>
        </div>
        <div class="right-column">
          <div class="imdb-rating-circle" id="imdb-rating-circle" style="display: none;">
            <div class="rating-circle" id="rating-circle"><span id="rating-value">0</span></div>
            <span class="rating-text">IMDB Rating</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="trailer-container" id="trailer-container" style="display: none;">
    <h3 class="trailer-title">Trailer</h3>
    <div class="iframe-container" id="trailer-iframe-container" role="region" aria-label="Movie trailer"></div>
  </div>

  <script>
    const searchInput = document.getElementById("search-box");
    const searchResultsContainer = document.getElementById("search");
    const iframeContainer = document.getElementById("iframe-container");
    const trailerContainer = document.getElementById("trailer-container");
    const trailerIframeContainer = document.getElementById("trailer-iframe-container");
    const trailerTitle = document.querySelector(".trailer-title");
    const categoryList = document.getElementById("category-list");
    const sourceSelection = document.getElementById("source-selection");
    const imdbRatingCircle = document.getElementById("imdb-rating-circle");
    const ratingCircle = document.getElementById("rating-circle");
    const ratingValue = document.getElementById("rating-value");
    const movieInfo = document.getElementById("movie-info");
    const moviePlot = document.getElementById("movie-plot");
    const director = document.getElementById("director");
    const mainCast = document.getElementById("main-cast");
    const imdbCategories = document.getElementById("imdb-categories");
    const releaseYear = document.getElementById("release-year");

    const TMDB_API_KEY = 'ef93f865877bb70f8175a613d28b8ebe';
    let movieDataCache = JSON.parse(localStorage.getItem('movieDataCache') || '{}');
    let genreMap = null;

    const normalize = (str) => str?.toLowerCase().trim() || '';

    function debounce(func, wait) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }

    async function fetchGenreMap() {
      if (genreMap) return genreMap;
      try {
        const res = await fetch(`https://api.themoviedb.org/3/genre/movie/list?api_key=${TMDB_API_KEY}&language=en-US`);
        const data = await res.json();
        genreMap = {};
        data.genres.forEach(g => genreMap[g.id] = g.name);
        return genreMap;
      } catch (e) { console.error(e); return {}; }
    }

    async function fetchMovieData(movie) {
      const cacheKey = normalize(movie.name);
      if (movieDataCache[cacheKey] && movieDataCache[cacheKey].genre !== 'Unknown') {
        return movieDataCache[cacheKey];
      }

      const genreMap = await fetchGenreMap();
      let info = {
        rating: movie.rating || 'N/A',
        plot: movie.plot || 'Plot not available',
        director: movie.director || 'N/A',
        actors: movie.actors || [],
        genre: movie.genre || 'Unknown',
        release_year: movie.release_year || 'N/A',
        thumbnail: movie.thumbnail && movie.thumbnail.trim() ? movie.thumbnail : 'path/to/placeholder.jpg'
      };

      if (movie.imdbID) {
        try {
          const res = await fetch(`https://api.themoviedb.org/3/find/${movie.imdbID}?api_key=${TMDB_API_KEY}&external_source=imdb_id`);
          const data = await res.json();
          const m = data.movie_results?.[0] || data.tv_results?.[0];
          if (m) {
            const details = await fetch(`https://api.themoviedb.org/3/${m.media_type || 'movie'}/${m.id}?api_key=${TMDB_API_KEY}`);
            const det = await details.json();
            const credits = await fetch(`https://api.themoviedb.org/3/${m.media_type || 'movie'}/${m.id}/credits?api_key=${TMDB_API_KEY}`);
            const cred = await credits.json();

            info = {
              rating: det.vote_average ? det.vote_average.toFixed(1) : info.rating,
              plot: det.overview || info.plot,
              director: cred.crew?.find(c => c.job === 'Director')?.name || info.director,
              actors: cred.cast?.slice(0, 5).map(a => a.name) || info.actors,
              genre: det.genre_ids?.map(id => genreMap[id]).filter(Boolean).join(', ') || det.genres?.map(g => g.name).join(', ') || info.genre,
              release_year: (det.release_date || det.first_air_date || '').split('-')[0] || info.release_year,
              thumbnail: det.poster_path ? `https://image.tmdb.org/t/p/w500${det.poster_path}` : info.thumbnail
            };
          }
        } catch (e) { console.error(e); }
      } else {
        // Fallback: title search
        try {
          const q = encodeURIComponent(movie.name.replace(/[^\w\s]/g, ' ').trim());
          const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&query=${q}`);
          const data = await res.json();
          const m = data.results?.[0];
          if (m && m.poster_path) {
            const details = await fetch(`https://api.themoviedb.org/3/${m.media_type}/${m.id}?api_key=${TMDB_API_KEY}`);
            const det = await details.json();
            info.thumbnail = `https://image.tmdb.org/t/p/w500${det.poster_path}`;
          }
        } catch (e) { console.error(e); }
      }

      movieDataCache[cacheKey] = info;
      localStorage.setItem('movieDataCache', JSON.stringify(movieDataCache));
      return info;
    }

    function createSelectionButtons(container, items, labelKey, clickHandler, activeLabel) {
      container.innerHTML = "";
      container.style.display = items.length > 0 ? "block" : "none";
      items.forEach((item, i) => {
        const btn = document.createElement("div");
        btn.className = "button";
        btn.innerHTML = `<div class="button-outer"><div class="button-inner"><span>${item[labelKey] || `Source ${i+1}`}</span></div></div>`;
        btn.onclick = () => {
          clickHandler(item);
          container.querySelectorAll(".button").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        };
        if (item[labelKey] === activeLabel) btn.classList.add("active");
        container.appendChild(btn);
      });
    }

    async function loadVideo(video) {
      if (!video) {
        document.getElementById("video-title").textContent = "Video not found";
        return;
      }

      document.getElementById("video-title").textContent = video.name;
      document.title = video.name;

      const data = await fetchMovieData(video);

      const rating = parseFloat(data.rating);
      if (!isNaN(rating) && rating > 0) {
        ratingCircle.style.setProperty('--percentage', `${(rating / 10) * 100}%`);
        ratingValue.textContent = data.rating;
        imdbRatingCircle.style.display = "flex";
      } else {
        imdbRatingCircle.style.display = "none";
      }

      moviePlot.textContent = data.plot;
      director.textContent = data.director !== 'N/A' ? data.director : 'N/A';
      mainCast.textContent = data.actors.length ? data.actors.join(', ') : 'N/A';
      imdbCategories.textContent = data.genre !== 'Unknown' ? data.genre : 'Unknown';
      releaseYear.textContent = data.release_year !== 'N/A' ? data.release_year : 'N/A';
      movieInfo.style.display = "block";

      const sources = Array.isArray(video.sources) ? video.sources : [];
      createSelectionButtons(sourceSelection, sources, "label", src => {
        iframeContainer.innerHTML = src.embed_code || "";
        iframeContainer.style.display = "block";
      }, sources[0]?.label);

      if (sources.length > 0) {
        iframeContainer.innerHTML = sources[0].embed_code || "";
        iframeContainer.style.display = "block";
      } else {
        iframeContainer.style.display = "none";
      }

      if (video.trailer) {
        trailerIframeContainer.innerHTML = video.trailer;
        trailerContainer.style.display = "block";
        setTimeout(() => trailerTitle.classList.add("visible"), 10);
      } else {
        trailerIframeContainer.innerHTML = '<p>No trailer available</p>';
        trailerContainer.style.display = "none";
        trailerTitle.classList.remove("visible");
      }
    }

    async function loadCategories() {
      try {
        const data = await fetch("movies.json").then(r => r.ok ? r.json() : []);
        const cats = [...new Set(data.map(r => r.category).filter(Boolean))];
        categoryList.innerHTML = cats.map(c =>
          `<a href="category.html#${encodeURIComponent(c.replace(/\s+/g,''))}">${c}</a>`
        ).join('');
      } catch (e) { console.error(e); }
    }

    async function loadMovie() {
      const hash = window.location.hash.substring(1);
      if (!hash) {
        document.getElementById("video-title").textContent = "Video name missing in URL";
        return;
      }

      try {
        const movies = await fetch("movies.json").then(r => r.ok ? r.json() : []);
        const video = movies.find(v => normalize(v.name.replace(/\s+/g, '')) === normalize(hash));
        if (video) await loadVideo(video);
        else document.getElementById("video-title").textContent = "Video not found";
      } catch (e) {
        console.error(e);
        document.getElementById("video-title").textContent = "Error loading video";
      }
    }

    async function handleSearch() {
      const query = searchInput.value.trim().toLowerCase();
      if (!query) {
        searchResultsContainer.style.display = "none";
        searchResultsContainer.innerHTML = "";
        return;
      }

      const [movies, series] = await Promise.all([
        fetch("movies.json").then(r => r.ok ? r.json() : []).catch(() => []),
        fetch("series.json").then(r => r.ok ? r.json() : []).catch(() => [])
      ]);

      const allVideos = [
        ...movies.map(m => ({ ...m, type: 'movie' })),
        ...series.map(s => ({ ...s, type: 'series' }))
      ];

      const matches = allVideos
        .filter(v => v.name && v.name.toLowerCase().includes(query))
        .slice(0, 5);

      searchResultsContainer.innerHTML = "";
      if (matches.length === 0) {
        searchResultsContainer.innerHTML = `<div class="no-results">No results found</div>`;
      } else {
        for (const video of matches) {
          const cacheKey = normalize(video.name);
          let thumb = 'path/to/placeholder.jpg';

          if (movieDataCache[cacheKey]?.thumbnail) {
            thumb = movieDataCache[cacheKey].thumbnail;
          } else if (video.imdbID) {
            const data = await fetchMovieData(video);
            thumb = data.thumbnail;
          } else if (video.thumbnail && video.thumbnail.trim()) {
            thumb = video.thumbnail;
          }

          const div = document.createElement("div");
          div.className = "search-suggestion";
          div.innerHTML = `
            <img src="${thumb}" alt="${video.name}" onerror="this.src='path/to/placeholder.jpg'">
            <span>${video.name}</span>
          `;
          const page = video.type === 'movie' ? 'movie.html' : 'series.html';
          div.onclick = () => location.href = `${page}#${encodeURIComponent(video.name.replace(/\s+/g, ''))}`;
          searchResultsContainer.appendChild(div);
        }
      }
      searchResultsContainer.style.display = matches.length ? "block" : "none";
    }

    function handleEnter(e) {
      if (e.key === "Enter" && searchInput.value.trim()) {
        location.href = `search.html#keyword=${encodeURIComponent(searchInput.value.trim())}`;
      }
    }

    async function initialize() {
      await loadCategories();
      await loadMovie();
    }

    searchInput.addEventListener("input", debounce(handleSearch, 300));
    searchInput.addEventListener("keydown", handleEnter);

    document.addEventListener("DOMContentLoaded", () => {
      const dropdown = document.querySelector(".dropdown");
      const dropdownContent = document.querySelector(".dropdown-content");
      const navbar = document.querySelector(".navbar");
      let lastScrollTop = 0;

      window.addEventListener("scroll", () => {
        const st = window.pageYOffset;
        navbar.classList.toggle("fixed", st > lastScrollTop);
        lastScrollTop = st <= 0 ? 0 : st;
      });

      dropdown.addEventListener("click", e => {
        e.stopPropagation();
        const isOpen = dropdownContent.style.display === "block";
        dropdownContent.style.display = isOpen ? "none" : "block";
        dropdown.setAttribute("aria-expanded", !isOpen);
      });

      document.addEventListener("click", e => {
        if (!dropdown.contains(e.target)) {
          dropdownContent.style.display = "none";
          dropdown.setAttribute("aria-expanded", "false");
        }
      });

      initialize();
    });
  </script>
</body>
</html>